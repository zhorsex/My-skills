# 写作方向推荐算法

本文档定义了 report-generator skill 中用于智能推荐写作方向的算法逻辑。

---

## 概述

本算法基于三个维度综合评分，为每个章节的每个写作方向维度推荐最适合的方向：

- **章节标题匹配度** (30%): 基于章节标题关键词与方向关键词的匹配程度
- **写作人设匹配度** (40%): 基于用户选择的写作人设与方向的适配程度  
- **资料丰富度匹配度** (30%): 基于已搜集资料的类型、数量和质量

**综合得分公式**:
```
综合得分 = (标题匹配分 × 0.3) + (人设匹配分 × 0.4) + (资料匹配分 × 0.3)
```

---

## 评分维度

### 1. 章节标题匹配度 (权重: 30%)

#### 匹配逻辑

1. **提取章节标题关键词**
   - 从当前章节标题中提取核心关键词
   - 例如："工程设计方案" → 关键词："方案"、"设计"、"工程"

2. **匹配方向关键词**
   - 与 `writing-directions.md` 中定义的"关键词匹配"字段进行匹配
   - 匹配规则：
     - **完全匹配** (关键词完全相同): +5分
     - **部分匹配** (关键词相似或相关): +3分  
     - **无匹配**: +0分

3. **计算标题匹配得分**
   - 对每个方向计算关键词匹配总分
   - 取该维度下所有方向中的最高分作为基准
   - 归一化处理

#### 匹配示例

**章节标题**: "工程设计方案"

| 方向 | 关键词匹配 | 得分 |
|-----|-----------|-----|
| 技术方案 | "方案"(完全) + "设计"(部分) | 5 + 3 = 8分 |
| 实施细节 | "工程"(部分) | 3分 |
| 背景介绍 | 无匹配 | 0分 |
| 问题诊断 | 无匹配 | 0分 |

**标题匹配得分计算** (以5分制):
- 技术方案: 8分 → 5分 (最高)
- 实施细节: 3分 → 1.875分 (按比例)
- 背景介绍: 0分 → 0分
- 问题诊断: 0分 → 0分

---

### 2. 写作人设匹配度 (权重: 40%)

#### 人设与方向关联规则

不同写作人设倾向于不同的写作方向组合：

| 写作人设 | 推荐内容侧重 | 推荐技术深度 | 推荐叙述风格 | 推荐读者视角 |
|---------|-------------|-------------|-------------|-------------|
| **高级工程师/技术专家** | 技术方案、创新亮点 | 原理讲解、深入研究 | 客观描述、数据支撑 | 技术人员视角、专家视角 |
| **项目经理/负责人** | 实施细节、效益评估 | 应用说明、实践指导 | 问题导向、流程导向 | 决策者视角、管理者视角 |
| **技术顾问/咨询师** | 对比分析、效益评估 | 综合分析、趋势预测 | 主观建议、对比论证 | 决策者视角、投资者视角 |
| **学术研究员** | 深入研究、创新亮点 | 深入研究、原理讲解 | 数据支撑、客观描述 | 专家视角、审查者视角 |

#### 评分逻辑

对于每个方向维度：

- **匹配推荐方向**: +5分
  - 该方向在人设的推荐列表中
- **次选方向**: +3分  
  - 该方向与人设风格相关但不完全匹配
- **其他方向**: +1分
  - 该方向在人设推荐列表之外

#### 评分示例

**写作人设**: 高级工程师/技术专家  
**维度**: 内容侧重

| 方向 | 人设匹配 | 得分 |
|-----|---------|-----|
| 技术方案 | 推荐列表中 | +5分 |
| 创新亮点 | 推荐列表中 | +5分 |
| 实施细节 | 次选相关 | +3分 |
| 效益评估 | 次选相关 | +3分 |
| 风险分析 | 其他 | +1分 |
| 对比分析 | 其他 | +1分 |
| 背景介绍 | 其他 | +1分 |
| 问题诊断 | 其他 | +1分 |

---

### 3. 资料丰富度匹配度 (权重: 30%)

#### 评估指标

1. **参考资料数量**
   - 0-2份: +1分
   - 3-5份: +3分
   - 6-10份: +5分
   - 10份以上: +5分 (额外加分)

2. **参考资料质量**
   - 权威来源 (标准/规范/官方): +3分
   - 专业来源 (论文/报告): +2分
   - 一般来源 (网页/文章): +1分

3. **数据完整性**
   - 包含统计数据: +3分
   - 包含图表资料: +2分
   - 包含案例数据: +2分

4. **案例丰富度**
   - 3个以上实际案例: +3分
   - 1-2个案例: +2分
   - 无案例: +0分

#### 资料类型与方向匹配

根据已搜集资料的类型，推荐相应方向：

- **资料丰富度高 + 数据多** → 推荐"数据支撑"叙述风格
- **案例资料多** → 推荐"案例驱动"叙述风格  
- **理论资料多** → 推荐"原理讲解"技术深度
- **对比资料多** → 推荐"对比分析"内容侧重
- **实施资料多** → 推荐"实施细节"内容侧重

#### 评分示例

**已搜集资料**:
- 5份技术文档 (专业来源)
- 3个实施案例
- 2份数据报告

**资料评分**:
- 数量 >5份: +5分
- 专业来源: +2分 × 5 = 10分 (封顶5分)
- 包含数据: +3分
- 包含案例: +3分
- **总分**: 5 + 5 + 3 + 3 = 16分 → 归一化为5分

---

## 推荐算法流程

```
算法: 推荐写作方向
输入: 
  - 章节标题 (chapter_title)
  - 写作人设 (writing_persona)
  - 已搜集资料清单 (materials)
输出:
  - 各维度推荐方向及标记

步骤:
1. 初始化
   - 获取当前维度所有方向选项 (8个)
   - 初始化得分表

2. 计算标题匹配分 (30%)
   - 提取章节标题关键词
   - 对每个方向计算关键词匹配得分
   - 归一化到5分制

3. 计算人设匹配分 (40%)
   - 根据 writing_persona 查人设-方向映射表
   - 对每个方向计算人设匹配得分

4. 计算资料匹配分 (30%)
   - 统计资料数量、类型、质量
   - 根据资料类型匹配推荐方向
   - 计算资料匹配得分

5. 计算综合得分
   - 综合得分 = (标题分 × 0.3) + (人设分 × 0.4) + (资料分 × 0.3)
   - 对每个方向计算综合得分

6. 排序与推荐
   - 按综合得分降序排序
   - 最高分方向: 标记"⭐ 综合推荐"
   - 次高分方向: 标记"🌟 备选推荐"

7. 检查特殊推荐
   - 如果人设分最高但非综合最高: 额外标记"🌟 基于人设推荐"
   - 如果资料分最高: 额外标记"📊 基于资料推荐"
   - 如果标题分最高: 额外标记"📝 基于标题推荐"

8. 输出推荐结果
   - 显示所有方向及推荐标记
   - 等待用户选择
```

---

## 推荐标记规则

### 标记类型说明

#### 1. ⭐ 综合推荐 (Comprehensive Recommendation)

- **条件**: 综合得分最高
- **含义**: 基于标题、人设、资料三个因素的综合最优选择
- **显示**: 在所有推荐标记中最优先显示

#### 2. 🌟 基于人设推荐 (Persona-based Recommendation)

- **条件**: 人设匹配得分最高，但综合得分非最高
- **含义**: 特别符合当前写作人设风格的选择
- **适用**: 当用户特别注重人设一致性时使用

#### 3. 📊 基于资料推荐 (Material-based Recommendation)

- **条件**: 资料匹配得分最高
- **含义**: 基于当前资料特点的最佳选择
- **适用**: 当已搜集资料丰富且质量高时

#### 4. 📝 基于标题推荐 (Title-based Recommendation)

- **条件**: 标题匹配得分最高
- **含义**: 基于章节标题关键词的最佳选择
- **适用**: 当章节标题特征明显时

### 标记显示规则

1. **综合推荐**始终显示在第一位置
2. **专项推荐**可以叠加显示
3. 示例显示格式：
   - `⭐ 综合推荐 - 技术方案`
   - `⭐ 综合推荐 / 🌟 基于人设推荐 - 技术方案`
   - `🌟 基于人设推荐 - 创新亮点`

---

## 特殊情况处理

### 1. 多方向同分处理

**场景**: 多个方向得分相同（相差 < 0.5分）

**处理规则**:
1. 优先推荐与写作人设最匹配的方向
2. 如果人设匹配也相同，优先推荐更通用的方向
3. 如果仍相同，按字母顺序选择

**示例**:
- 技术方案: 4.7分
- 创新亮点: 4.65分 (差0.05 < 0.5)
- 实施细节: 4.6分

→ 选择"技术方案" (人设匹配度更高)

### 2. 得分过低处理

**场景**: 最高得分 < 5分

**处理规则**:
1. 显示警告信息：
   ```
   ⚠️ 当前资料/信息不足以给出明确推荐
   建议先搜集更多资料，或选择通用方向
   ```
2. 提供通用默认选项：
   - 内容侧重: 背景介绍
   - 技术深度: 简明概述
   - 叙述风格: 客观描述
   - 读者视角: 普通读者视角
3. 询问用户是否继续或先搜集资料

### 3. 用户自定义方向

**场景**: 用户选择"自定义方向"

**处理规则**:
1. 记录用户自定义的方向描述
2. 记录到 `usage-log.md` 的"自定义方向"部分
3. 在后续章节中作为学习样本
4. 后续推荐时考虑用户历史偏好

### 4. 资料不足时的推荐

**场景**: 步骤2.1.5在步骤2.2之前，资料尚未搜集

**处理规则**:
1. 仅使用标题匹配 (30%) 和 人设匹配 (40%)
2. 资料匹配分设为默认值 (3分，中等)
3. 算法调整为：
   ```
   综合得分 = (标题分 × 0.375) + (人设分 × 0.625)
   ```
4. 提示用户："推荐基于章节标题和写作人设，搜集资料后会更准确"

---

## 使用示例

### 场景

- **章节**: 第3章"工程设计方案"
- **写作人设**: 高级工程师/技术专家
- **已搜集资料**: 5份技术文档、3个案例、2份数据报告

### 维度一：内容侧重 评分计算

#### 1. 标题匹配分 (30%)

**章节标题**: "工程设计方案" → 关键词："方案"、"设计"、"工程"

| 方向 | 关键词匹配 | 原始分 | 归一化分 |
|-----|-----------|-------|---------|
| 技术方案 | 方案(完全)+设计(部分) | 8 | 5 |
| 实施细节 | 工程(部分) | 3 | 1.875 |
| 风险分析 | 无 | 0 | 0 |
| 效益评估 | 无 | 0 | 0 |
| 对比分析 | 方案(完全) | 5 | 3.125 |
| 创新亮点 | 设计(部分) | 3 | 1.875 |
| 背景介绍 | 无 | 0 | 0 |
| 问题诊断 | 无 | 0 | 0 |

#### 2. 人设匹配分 (40%)

**人设**: 高级工程师/技术专家  
**推荐方向**: 技术方案、创新亮点

| 方向 | 人设匹配 | 得分 |
|-----|---------|-----|
| 技术方案 | 推荐列表 | 5 |
| 创新亮点 | 推荐列表 | 5 |
| 实施细节 | 次选 | 3 |
| 效益评估 | 次选 | 3 |
| 风险分析 | 其他 | 1 |
| 对比分析 | 其他 | 1 |
| 背景介绍 | 其他 | 1 |
| 问题诊断 | 其他 | 1 |

#### 3. 资料匹配分 (30%)

**资料统计**:
- 数量: 10份 (5+3+2) → 5分
- 质量: 技术文档(专业) × 5 → 封顶5分
- 数据: 数据报告 × 2 → 3分
- 案例: 案例 × 3 → 3分
- **总分**: 5+5+3+3 = 16 → 归一化5分

**资料类型匹配**:
- 技术文档多 → 技术方案、创新亮点 (高分)
- 案例多 → 实施细节 (次高分)

| 方向 | 资料匹配 | 得分 |
|-----|---------|-----|
| 技术方案 | 高度匹配 | 5 |
| 创新亮点 | 高度匹配 | 5 |
| 实施细节 | 次匹配 | 4 |
| 对比分析 | 部分匹配 | 3 |
| 其他 | 一般 | 2 |

#### 4. 综合得分计算

| 方向 | 标题分×0.3 | 人设分×0.4 | 资料分×0.3 | 综合得分 | 排名 |
|-----|-----------|-----------|-----------|---------|-----|
| 技术方案 | 5×0.3=1.5 | 5×0.4=2.0 | 5×0.3=1.5 | **5.0** | 1 |
| 创新亮点 | 1.875×0.3=0.56 | 5×0.4=2.0 | 5×0.3=1.5 | **4.06** | 2 |
| 实施细节 | 1.875×0.3=0.56 | 3×0.4=1.2 | 4×0.3=1.2 | **2.96** | 3 |
| 对比分析 | 3.125×0.3=0.94 | 1×0.4=0.4 | 3×0.3=0.9 | **2.24** | 4 |
| 其他 | <2 | <0.4 | <0.6 | <2 | 5-8 |

#### 5. 推荐结果

**推荐标记**:
- 技术方案: ⭐ 综合推荐 (得分5.0，标题、人设、资料均匹配)
- 创新亮点: 🌟 基于人设推荐 (人设分5分，与人设高度匹配)

**显示给用户**:

```
维度一：内容侧重方向选择

A. ⭐ 综合推荐 - 技术方案
   - 综合得分: 5.0 (满分)
   - 标题匹配: 5分 × 30% = 1.5
   - 人设匹配: 5分 × 40% = 2.0
   - 资料匹配: 5分 × 30% = 1.5
   - 推荐理由: 章节标题、写作人设、资料情况均高度匹配

B. 🌟 基于人设推荐 - 创新亮点
   - 综合得分: 4.06
   - 人设匹配: 5分 (最高分)
   - 推荐理由: 符合高级工程师人设对技术创新的关注

C. 实施细节 (得分: 2.96)
D. 对比分析 (得分: 2.24)
E. 风险分析 (得分: <2)
F. 效益评估 (得分: <2)
G. 背景介绍 (得分: <2)
H. 问题诊断 (得分: <2)
```

---

## 算法优化建议

### 1. 权重调整

根据实际使用情况，可以调整三个维度的权重：

```python
# 默认权重
TITLE_WEIGHT = 0.3
PERSONA_WEIGHT = 0.4
MATERIAL_WEIGHT = 0.3

# 场景化权重调整
if chapter_type == "背景介绍":
    TITLE_WEIGHT = 0.5  # 标题更重要
    PERSONA_WEIGHT = 0.3
    MATERIAL_WEIGHT = 0.2
```

### 2. 学习优化

基于用户历史选择优化推荐：

```python
# 记录用户选择历史
user_preferences = {
    "内容侧重": ["技术方案", "技术方案", "创新亮点"],  # 历史选择
    "技术深度": ["原理讲解", "综合分析"]
}

# 在推荐时考虑历史偏好
if direction in user_preferences[dimension]:
    score += 0.5  # 历史选择加分
```

### 3. 反馈循环

每次用户选择后记录反馈：

```markdown
## 推荐准确度分析

| 章节 | 推荐方向 | 用户选择 | 是否采纳 | 原因 |
|-----|---------|---------|---------|-----|
| 第1章 | 技术方案 | 技术方案 | 是 | - |
| 第2章 | 背景介绍 | 问题诊断 | 否 | 用户更关注问题 |

准确度 = 采纳次数 / 总次数 = 50%
```

---

## 实现注意事项

1. **实时计算**: 每次进入步骤2.1.5时实时计算推荐
2. **动态更新**: 如果用户在步骤2.2搜集了新资料，可重新计算推荐
3. **用户覆盖**: 用户可以选择非推荐方向，系统应尊重用户选择
4. **记录完整**: 记录完整的评分详情，用于后续优化
5. **性能考虑**: 8个方向的计算量很小，无需性能优化

---

## 总结

本算法通过三个维度（标题、人设、资料）综合评分，为每个写作方向维度智能推荐最适合的方向。算法设计考虑了：

- ✅ 多维度综合评估
- ✅ 权重可配置
- ✅ 特殊情况处理
- ✅ 学习优化机制
- ✅ 用户选择权尊重

算法逻辑清晰，易于实现，能够有效辅助用户选择合适的写作方向。

---

*本文档为 report-generator skill 的配套资源，用于指导写作方向推荐算法的实现。*
